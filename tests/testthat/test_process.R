test_that("adding cumulative log column sums correctly", {
  credit_data <- tibble::tibble(
    work_unit = c("WU01", "WU02", "WU02", "WU02", "WU00"),
    folding_slot = c("FS01", "FS00", "FS00", "FS01", "FS00"),
    credits_attributed = c(65847, 6715, 1000, 9405, 4283),
    log_time = c("23:25:47", "04:36:53", "07:22:44", "13:27:32", "17:13:22"),
    log_date = structure(c(18348, 18349, 18349, 18349, 18349), class = "Date"),
    log_timestamp = structure(
      c(1585351547, 1585370213, 1585380164, 1585402052, 1585415602),
      tzone = "UTC", class = c("POSIXct","POSIXt"))
  )

  actual <- fahlogstats:::add_cumulative_sum(log_df = credit_data,
                                             sum_column = credits_attributed,
                                             date_column = log_date,
                                             folding_slot)

  expect_true("cumulative_credits_attributed" %in% colnames(actual))
  expect_equal(actual$cumulative_credits_attributed,
               c(6715, 7715, 11998, 65847, 75252))
})

test_that(
  "import & cleaning gives right date when the date rolls over at midnight", {
  log_file_path <- "./testdata/test_process/"
  actual_in <- tibble::tibble(log_file_name = "log-20200409-124015.txt")

  actual_out <- read_fah_logs(actual_in, log_file_path) %>% clean_logs()

  actual <-
    actual_out$log_timestamp %>%
    as.Date() %>%
    unique() %>%
    sort()

  expect_equal(actual,
               c(lubridate::ymd("2020-04-09"),
                 lubridate::ymd("2020-04-10"),
                 lubridate::ymd("2020-04-11"))
  )
})

test_that(
  "cleaning parses a log into the correct columns for a single work unit row", {
    actual_input <-
     tibble::tibble(log_file_name = "log-20200329-131612.txt",
                    message = "17:52:59:WU01:FS00:0xa7:Completed 92500 out of 125000 steps (74%)",
                    log_date = structure(18350, class = "Date"))

    actual_output <- clean_logs(actual_input)
    expect_equal(actual_output$`1`, "WU01")
    expect_equal(actual_output$`2`, "FS00")
    expect_equal(actual_output$`3`, "0xa7")
    expect_equal(actual_output$log_date, as.Date("2020-03-29"))
    expect_equal(actual_output$log_time, "17:52:59")
    expect_equal(actual_output$log_timestamp, lubridate::ymd_hms("2020-03-29 17:52:59"))
    expect_equal(nrow(actual_output), 1)
  })
